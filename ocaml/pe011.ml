open Core.Std

(* allocate our matrix with a border of 0 *)
(* so that we null any products outside *)

let matbase = 20 ;;
let vnum = 4 ;;
let maxij = matbase + vnum - 2 ;;
let minij = vnum - 1 ;;
let matdim = maxij + minij + 1 ;;

let m = Array.make_matrix ~dimx:matdim ~dimy:matdim 0 ;;

(* surely there is a better way to initialise a matrix than this *)

m.(3).(3) <- 8 ;;
m.(3).(4) <- 2 ;;
m.(3).(5) <- 22 ;;
m.(3).(6) <- 97 ;;
m.(3).(7) <- 38 ;;
m.(3).(8) <- 15 ;;
m.(3).(9) <- 0 ;;
m.(3).(10) <- 40 ;;
m.(3).(11) <- 0 ;;
m.(3).(12) <- 75 ;;
m.(3).(13) <- 4 ;;
m.(3).(14) <- 5 ;;
m.(3).(15) <- 7 ;;
m.(3).(16) <- 78 ;;
m.(3).(17) <- 52 ;;
m.(3).(18) <- 12 ;;
m.(3).(19) <- 50 ;;
m.(3).(20) <- 77 ;;
m.(3).(21) <- 91 ;;
m.(3).(22) <- 8 ;;
m.(4).(3) <- 49 ;;
m.(4).(4) <- 49 ;;
m.(4).(5) <- 99 ;;
m.(4).(6) <- 40 ;;
m.(4).(7) <- 17 ;;
m.(4).(8) <- 81 ;;
m.(4).(9) <- 18 ;;
m.(4).(10) <- 57 ;;
m.(4).(11) <- 60 ;;
m.(4).(12) <- 87 ;;
m.(4).(13) <- 17 ;;
m.(4).(14) <- 40 ;;
m.(4).(15) <- 98 ;;
m.(4).(16) <- 43 ;;
m.(4).(17) <- 69 ;;
m.(4).(18) <- 48 ;;
m.(4).(19) <- 4 ;;
m.(4).(20) <- 56 ;;
m.(4).(21) <- 62 ;;
m.(4).(22) <- 0 ;;
m.(5).(3) <- 81 ;;
m.(5).(4) <- 49 ;;
m.(5).(5) <- 31 ;;
m.(5).(6) <- 73 ;;
m.(5).(7) <- 55 ;;
m.(5).(8) <- 79 ;;
m.(5).(9) <- 14 ;;
m.(5).(10) <- 29 ;;
m.(5).(11) <- 93 ;;
m.(5).(12) <- 71 ;;
m.(5).(13) <- 40 ;;
m.(5).(14) <- 67 ;;
m.(5).(15) <- 53 ;;
m.(5).(16) <- 88 ;;
m.(5).(17) <- 30 ;;
m.(5).(18) <- 3 ;;
m.(5).(19) <- 49 ;;
m.(5).(20) <- 13 ;;
m.(5).(21) <- 36 ;;
m.(5).(22) <- 65 ;;
m.(6).(3) <- 52 ;;
m.(6).(4) <- 70 ;;
m.(6).(5) <- 95 ;;
m.(6).(6) <- 23 ;;
m.(6).(7) <- 4 ;;
m.(6).(8) <- 60 ;;
m.(6).(9) <- 11 ;;
m.(6).(10) <- 42 ;;
m.(6).(11) <- 69 ;;
m.(6).(12) <- 24 ;;
m.(6).(13) <- 68 ;;
m.(6).(14) <- 56 ;;
m.(6).(15) <- 1 ;;
m.(6).(16) <- 32 ;;
m.(6).(17) <- 56 ;;
m.(6).(18) <- 71 ;;
m.(6).(19) <- 37 ;;
m.(6).(20) <- 2 ;;
m.(6).(21) <- 36 ;;
m.(6).(22) <- 91 ;;
m.(7).(3) <- 22 ;;
m.(7).(4) <- 31 ;;
m.(7).(5) <- 16 ;;
m.(7).(6) <- 71 ;;
m.(7).(7) <- 51 ;;
m.(7).(8) <- 67 ;;
m.(7).(9) <- 63 ;;
m.(7).(10) <- 89 ;;
m.(7).(11) <- 41 ;;
m.(7).(12) <- 92 ;;
m.(7).(13) <- 36 ;;
m.(7).(14) <- 54 ;;
m.(7).(15) <- 22 ;;
m.(7).(16) <- 40 ;;
m.(7).(17) <- 40 ;;
m.(7).(18) <- 28 ;;
m.(7).(19) <- 66 ;;
m.(7).(20) <- 33 ;;
m.(7).(21) <- 13 ;;
m.(7).(22) <- 80 ;;
m.(8).(3) <- 24 ;;
m.(8).(4) <- 47 ;;
m.(8).(5) <- 32 ;;
m.(8).(6) <- 60 ;;
m.(8).(7) <- 99 ;;
m.(8).(8) <- 3 ;;
m.(8).(9) <- 45 ;;
m.(8).(10) <- 2 ;;
m.(8).(11) <- 44 ;;
m.(8).(12) <- 75 ;;
m.(8).(13) <- 33 ;;
m.(8).(14) <- 53 ;;
m.(8).(15) <- 78 ;;
m.(8).(16) <- 36 ;;
m.(8).(17) <- 84 ;;
m.(8).(18) <- 20 ;;
m.(8).(19) <- 35 ;;
m.(8).(20) <- 17 ;;
m.(8).(21) <- 12 ;;
m.(8).(22) <- 50 ;;
m.(9).(3) <- 32 ;;
m.(9).(4) <- 98 ;;
m.(9).(5) <- 81 ;;
m.(9).(6) <- 28 ;;
m.(9).(7) <- 64 ;;
m.(9).(8) <- 23 ;;
m.(9).(9) <- 67 ;;
m.(9).(10) <- 10 ;;
m.(9).(11) <- 26 ;;
m.(9).(12) <- 38 ;;
m.(9).(13) <- 40 ;;
m.(9).(14) <- 67 ;;
m.(9).(15) <- 59 ;;
m.(9).(16) <- 54 ;;
m.(9).(17) <- 70 ;;
m.(9).(18) <- 66 ;;
m.(9).(19) <- 18 ;;
m.(9).(20) <- 38 ;;
m.(9).(21) <- 64 ;;
m.(9).(22) <- 70 ;;
m.(10).(3) <- 67 ;;
m.(10).(4) <- 26 ;;
m.(10).(5) <- 20 ;;
m.(10).(6) <- 68 ;;
m.(10).(7) <- 2 ;;
m.(10).(8) <- 62 ;;
m.(10).(9) <- 12 ;;
m.(10).(10) <- 20 ;;
m.(10).(11) <- 95 ;;
m.(10).(12) <- 63 ;;
m.(10).(13) <- 94 ;;
m.(10).(14) <- 39 ;;
m.(10).(15) <- 63 ;;
m.(10).(16) <- 8 ;;
m.(10).(17) <- 40 ;;
m.(10).(18) <- 91 ;;
m.(10).(19) <- 66 ;;
m.(10).(20) <- 49 ;;
m.(10).(21) <- 94 ;;
m.(10).(22) <- 21 ;;
m.(11).(3) <- 24 ;;
m.(11).(4) <- 55 ;;
m.(11).(5) <- 58 ;;
m.(11).(6) <- 5 ;;
m.(11).(7) <- 66 ;;
m.(11).(8) <- 73 ;;
m.(11).(9) <- 99 ;;
m.(11).(10) <- 26 ;;
m.(11).(11) <- 97 ;;
m.(11).(12) <- 17 ;;
m.(11).(13) <- 78 ;;
m.(11).(14) <- 78 ;;
m.(11).(15) <- 96 ;;
m.(11).(16) <- 83 ;;
m.(11).(17) <- 14 ;;
m.(11).(18) <- 88 ;;
m.(11).(19) <- 34 ;;
m.(11).(20) <- 89 ;;
m.(11).(21) <- 63 ;;
m.(11).(22) <- 72 ;;
m.(12).(3) <- 21 ;;
m.(12).(4) <- 36 ;;
m.(12).(5) <- 23 ;;
m.(12).(6) <- 9 ;;
m.(12).(7) <- 75 ;;
m.(12).(8) <- 0 ;;
m.(12).(9) <- 76 ;;
m.(12).(10) <- 44 ;;
m.(12).(11) <- 20 ;;
m.(12).(12) <- 45 ;;
m.(12).(13) <- 35 ;;
m.(12).(14) <- 14 ;;
m.(12).(15) <- 0 ;;
m.(12).(16) <- 61 ;;
m.(12).(17) <- 33 ;;
m.(12).(18) <- 97 ;;
m.(12).(19) <- 34 ;;
m.(12).(20) <- 31 ;;
m.(12).(21) <- 33 ;;
m.(12).(22) <- 95 ;;
m.(13).(3) <- 78 ;;
m.(13).(4) <- 17 ;;
m.(13).(5) <- 53 ;;
m.(13).(6) <- 28 ;;
m.(13).(7) <- 22 ;;
m.(13).(8) <- 75 ;;
m.(13).(9) <- 31 ;;
m.(13).(10) <- 67 ;;
m.(13).(11) <- 15 ;;
m.(13).(12) <- 94 ;;
m.(13).(13) <- 3 ;;
m.(13).(14) <- 80 ;;
m.(13).(15) <- 4 ;;
m.(13).(16) <- 62 ;;
m.(13).(17) <- 16 ;;
m.(13).(18) <- 14 ;;
m.(13).(19) <- 9 ;;
m.(13).(20) <- 53 ;;
m.(13).(21) <- 56 ;;
m.(13).(22) <- 92 ;;
m.(14).(3) <- 16 ;;
m.(14).(4) <- 39 ;;
m.(14).(5) <- 5 ;;
m.(14).(6) <- 42 ;;
m.(14).(7) <- 96 ;;
m.(14).(8) <- 35 ;;
m.(14).(9) <- 31 ;;
m.(14).(10) <- 47 ;;
m.(14).(11) <- 55 ;;
m.(14).(12) <- 58 ;;
m.(14).(13) <- 88 ;;
m.(14).(14) <- 24 ;;
m.(14).(15) <- 0 ;;
m.(14).(16) <- 17 ;;
m.(14).(17) <- 54 ;;
m.(14).(18) <- 24 ;;
m.(14).(19) <- 36 ;;
m.(14).(20) <- 29 ;;
m.(14).(21) <- 85 ;;
m.(14).(22) <- 57 ;;
m.(15).(3) <- 86 ;;
m.(15).(4) <- 56 ;;
m.(15).(5) <- 0 ;;
m.(15).(6) <- 48 ;;
m.(15).(7) <- 35 ;;
m.(15).(8) <- 71 ;;
m.(15).(9) <- 89 ;;
m.(15).(10) <- 7 ;;
m.(15).(11) <- 5 ;;
m.(15).(12) <- 44 ;;
m.(15).(13) <- 44 ;;
m.(15).(14) <- 37 ;;
m.(15).(15) <- 44 ;;
m.(15).(16) <- 60 ;;
m.(15).(17) <- 21 ;;
m.(15).(18) <- 58 ;;
m.(15).(19) <- 51 ;;
m.(15).(20) <- 54 ;;
m.(15).(21) <- 17 ;;
m.(15).(22) <- 58 ;;
m.(16).(3) <- 19 ;;
m.(16).(4) <- 80 ;;
m.(16).(5) <- 81 ;;
m.(16).(6) <- 68 ;;
m.(16).(7) <- 5 ;;
m.(16).(8) <- 94 ;;
m.(16).(9) <- 47 ;;
m.(16).(10) <- 69 ;;
m.(16).(11) <- 28 ;;
m.(16).(12) <- 73 ;;
m.(16).(13) <- 92 ;;
m.(16).(14) <- 13 ;;
m.(16).(15) <- 86 ;;
m.(16).(16) <- 52 ;;
m.(16).(17) <- 17 ;;
m.(16).(18) <- 77 ;;
m.(16).(19) <- 4 ;;
m.(16).(20) <- 89 ;;
m.(16).(21) <- 55 ;;
m.(16).(22) <- 40 ;;
m.(17).(3) <- 4 ;;
m.(17).(4) <- 52 ;;
m.(17).(5) <- 8 ;;
m.(17).(6) <- 83 ;;
m.(17).(7) <- 97 ;;
m.(17).(8) <- 35 ;;
m.(17).(9) <- 99 ;;
m.(17).(10) <- 16 ;;
m.(17).(11) <- 7 ;;
m.(17).(12) <- 97 ;;
m.(17).(13) <- 57 ;;
m.(17).(14) <- 32 ;;
m.(17).(15) <- 16 ;;
m.(17).(16) <- 26 ;;
m.(17).(17) <- 26 ;;
m.(17).(18) <- 79 ;;
m.(17).(19) <- 33 ;;
m.(17).(20) <- 27 ;;
m.(17).(21) <- 98 ;;
m.(17).(22) <- 66 ;;
m.(18).(3) <- 88 ;;
m.(18).(4) <- 36 ;;
m.(18).(5) <- 68 ;;
m.(18).(6) <- 87 ;;
m.(18).(7) <- 57 ;;
m.(18).(8) <- 62 ;;
m.(18).(9) <- 20 ;;
m.(18).(10) <- 72 ;;
m.(18).(11) <- 3 ;;
m.(18).(12) <- 46 ;;
m.(18).(13) <- 33 ;;
m.(18).(14) <- 67 ;;
m.(18).(15) <- 46 ;;
m.(18).(16) <- 55 ;;
m.(18).(17) <- 12 ;;
m.(18).(18) <- 32 ;;
m.(18).(19) <- 63 ;;
m.(18).(20) <- 93 ;;
m.(18).(21) <- 53 ;;
m.(18).(22) <- 69 ;;
m.(19).(3) <- 4 ;;
m.(19).(4) <- 42 ;;
m.(19).(5) <- 16 ;;
m.(19).(6) <- 73 ;;
m.(19).(7) <- 38 ;;
m.(19).(8) <- 25 ;;
m.(19).(9) <- 39 ;;
m.(19).(10) <- 11 ;;
m.(19).(11) <- 24 ;;
m.(19).(12) <- 94 ;;
m.(19).(13) <- 72 ;;
m.(19).(14) <- 18 ;;
m.(19).(15) <- 8 ;;
m.(19).(16) <- 46 ;;
m.(19).(17) <- 29 ;;
m.(19).(18) <- 32 ;;
m.(19).(19) <- 40 ;;
m.(19).(20) <- 62 ;;
m.(19).(21) <- 76 ;;
m.(19).(22) <- 36 ;;
m.(20).(3) <- 20 ;;
m.(20).(4) <- 69 ;;
m.(20).(5) <- 36 ;;
m.(20).(6) <- 41 ;;
m.(20).(7) <- 72 ;;
m.(20).(8) <- 30 ;;
m.(20).(9) <- 23 ;;
m.(20).(10) <- 88 ;;
m.(20).(11) <- 34 ;;
m.(20).(12) <- 62 ;;
m.(20).(13) <- 99 ;;
m.(20).(14) <- 69 ;;
m.(20).(15) <- 82 ;;
m.(20).(16) <- 67 ;;
m.(20).(17) <- 59 ;;
m.(20).(18) <- 85 ;;
m.(20).(19) <- 74 ;;
m.(20).(20) <- 4 ;;
m.(20).(21) <- 36 ;;
m.(20).(22) <- 16 ;;
m.(21).(3) <- 20 ;;
m.(21).(4) <- 73 ;;
m.(21).(5) <- 35 ;;
m.(21).(6) <- 29 ;;
m.(21).(7) <- 78 ;;
m.(21).(8) <- 31 ;;
m.(21).(9) <- 90 ;;
m.(21).(10) <- 1 ;;
m.(21).(11) <- 74 ;;
m.(21).(12) <- 31 ;;
m.(21).(13) <- 49 ;;
m.(21).(14) <- 71 ;;
m.(21).(15) <- 48 ;;
m.(21).(16) <- 86 ;;
m.(21).(17) <- 81 ;;
m.(21).(18) <- 16 ;;
m.(21).(19) <- 23 ;;
m.(21).(20) <- 57 ;;
m.(21).(21) <- 5 ;;
m.(21).(22) <- 54 ;;
m.(22).(3) <- 1 ;;
m.(22).(4) <- 70 ;;
m.(22).(5) <- 54 ;;
m.(22).(6) <- 71 ;;
m.(22).(7) <- 83 ;;
m.(22).(8) <- 51 ;;
m.(22).(9) <- 54 ;;
m.(22).(10) <- 69 ;;
m.(22).(11) <- 16 ;;
m.(22).(12) <- 92 ;;
m.(22).(13) <- 33 ;;
m.(22).(14) <- 48 ;;
m.(22).(15) <- 61 ;;
m.(22).(16) <- 43 ;;
m.(22).(17) <- 52 ;;
m.(22).(18) <- 1 ;;
m.(22).(19) <- 89 ;;
m.(22).(20) <- 19 ;;
m.(22).(21) <- 67 ;;
m.(22).(22) <- 48 ;;

let rec vprod n x incx y incy prod =
  if n = 0 then 
    prod
  else
    vprod (n - 1) (x + incx) incx (y+ incy) incy (prod * m.(x).(y)) ;;

let maxprod n x y =
 let a1 = max (vprod n x (-1) y (-1) 1) (vprod n x (-1) y 0 1) in
 let a2 = max (vprod n x (-1) y 1 1)  (vprod n x 0 y (-1) 1) in
 let a3 = max (vprod n x 0 y 1 1) (vprod n x 1 y (-1) 1) in
 let a4 = max (vprod n x 1 y 0 1) (vprod n x 1 y 1 1) in
 let b1 = max a1 a2 in
 let b2 = max a3 a4 in
   max b1 b2
 ;;

let rec getmax i j amax =
  if j = minij then
    if i = minij then
      printf "%d\n" amax
    else
      getmax (i - 1) maxij (max amax (maxprod vnum i j))
  else
    getmax i (j - 1) (max amax (maxprod vnum i j)) ;;

getmax maxij maxij 0 ;;
